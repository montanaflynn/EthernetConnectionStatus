name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0

jobs:
  release:
    name: Build and Release
    runs-on: macos-26

    permissions:
      contents: write  # Needed to create releases

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Build release
      run: |
        xcodebuild clean build \
          -project EthernetConnectionStatus.xcodeproj \
          -scheme EthernetConnectionStatus \
          -configuration Release \
          -derivedDataPath ./DerivedData \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Create application bundle
      run: |
        mkdir -p ./release
        cp -r "./DerivedData/Build/Products/Release/Ethernet Connection Status.app" "./release/"

        # Create a simple README for the release
        cat > "./release/README.txt" << 'EOF'
        Ethernet Connection Status v${{ steps.get_version.outputs.VERSION }}

        Installation:
        1. Extract this ZIP file
        2. Open Terminal and run this command to remove the quarantine attribute:

           xattr -cr "/path/to/Ethernet Connection Status.app"

           (Replace /path/to/ with the actual path where you extracted the app)

        3. Drag "Ethernet Connection Status.app" to your Applications folder
        4. Launch the app - it will appear in your menu bar

        IMPORTANT: This app is unsigned. macOS will block it from opening unless you
        remove the quarantine attribute using the command above. Right-clicking and
        selecting "Open" does NOT work for this app - you must use the xattr command.

        For more information: https://github.com/${{ github.repository }}
        EOF

    - name: Create ZIP archive
      run: |
        cd release
        zip -r "../EthernetConnectionStatus-v${{ steps.get_version.outputs.VERSION }}.zip" .
        cd ..

    - name: Calculate SHA256
      id: sha256
      run: |
        SHA256=$(shasum -a 256 "EthernetConnectionStatus-v${{ steps.get_version.outputs.VERSION }}.zip" | awk '{print $1}')
        echo "SHA256=$SHA256" >> $GITHUB_OUTPUT
        echo "Calculated SHA256: $SHA256"

    - name: Update Homebrew Cask
      run: |
        # Update version and SHA256 in the cask file
        sed -i '' "s/version \".*\"/version \"${{ steps.get_version.outputs.VERSION }}\"/" Casks/ethernet-connection-status.rb
        sed -i '' "s/sha256 \".*\"/sha256 \"${{ steps.sha256.outputs.SHA256 }}\"/" Casks/ethernet-connection-status.rb

        # Show the changes
        echo "Updated cask file:"
        cat Casks/ethernet-connection-status.rb

    - name: Commit and push cask update
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Casks/ethernet-connection-status.rb
        git commit -m "Update Homebrew cask to v${{ steps.get_version.outputs.VERSION }}"
        git push origin HEAD:main

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          EthernetConnectionStatus-v${{ steps.get_version.outputs.VERSION }}.zip
        body: |
          ## Ethernet Connection Status v${{ steps.get_version.outputs.VERSION }}

          ### Installation

          #### Option 1: Homebrew (Recommended)
          ```bash
          brew tap montanaflynn/EthernetConnectionStatus https://github.com/montanaflynn/EthernetConnectionStatus
          brew install --cask ethernet-connection-status
          ```

          #### Option 2: Manual Installation
          1. Download the `.zip` file below
          2. Extract the ZIP file
          3. **Remove quarantine attribute** - Open Terminal and run:
             ```bash
             xattr -cr "/path/to/Ethernet Connection Status.app"
             ```
             (Replace `/path/to/` with the actual location of the extracted app)
          4. Drag the app to your Applications folder
          5. Launch the app - it will appear in your menu bar

          ### What's New
          <!-- Add release notes here -->

          ### Important Note
          This is an **unsigned** build. macOS will block it from opening with a "damaged" warning.

          **You MUST use the `xattr` command above** - Right-clicking and selecting "Open" does NOT work for this app.

          The command removes the quarantine flag that macOS applies to downloaded files.

          ---

          **Requirements:** macOS 13.0 (Ventura) or later
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
